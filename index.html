<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-translate="title">La Luna Nel Pozzo</title>
  <style>
    /* General styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #e7b77f;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh; /* Ensure minimum height is full viewport */
    }

    header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      background-color: #e7b77f;
      position: fixed;
      top: 0;
      z-index: 1000;
      box-sizing: border-box;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 30px;
      height: 30px;
      background-color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-left: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }

    .flag-selector {
      font-size: 18px;
      cursor: pointer;
      padding-right: 15px;
    }

    /* Main content */
    .container {
      margin-top: 60px;
      width: calc(100% - 30px);
      max-width: 400px;
      box-sizing: border-box;
      flex: 1; /* Allow container to grow */
      padding-bottom: 60px; /* Space for footer */
    }

    .feedback-card {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 20px 15px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      box-sizing: border-box; /* Include padding in width calculation */
      width: 100%;
    }
    .feedback-card h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    .feedback-card .star-rating {
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .feedback-card .star-rating label {
      font-size: 2rem;
      color: #ccc;
      cursor: pointer;
    }
    .feedback-card .star-rating input {
      display: none;
    }
    /* Update star coloring behavior */
    .feedback-card .star-rating label:hover,
    .feedback-card .star-rating label:hover ~ label {
      color: #ffb400;
    }
    .feedback-card .star-rating input:checked + label,
    .feedback-card .star-rating input:checked + label ~ label {
      color: #ffb400;
    }
    #feedback-form {
      display: none;
      margin-top: 20px;
    }
    #feedback-form .feedback-prompt {
      text-align: left;
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }

    #feedback-form textarea {
      width: calc(100% - 30px);
      height: 80px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 14px;
      resize: none;
      margin-bottom: 10px;
    }

    /* Reward button */
    .reward-button {
      margin: 20px auto; /* Center the button with auto margins */
      display: block;
      background: black;
      color: white;
      text-align: center;
      padding: 15px 15px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 16px;
      font-weight: bold;
      width: calc(100% - 30px); /* Keep consistent width */
      box-sizing: border-box; /* Include padding in width calculation */
      cursor: pointer;
    }

    .chat-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-messages {
      height: 80vh; /* Set height to 80% of the viewport height */
      max-height: 80vh; /* Ensure it doesn't exceed this height */
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      background: white;
      text-align: left;
      margin-bottom: 10px; /* Add margin to separate from other elements */
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .user-message {
      background: #e7b77f;
      margin-left: auto;
      color: black;
    }

    .server-message {
      background: #f0f0f0;
      margin-right: auto;
    }

    .chat-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      max-width: 100%;
      box-sizing: border-box;
    }

    .chat-input textarea {
      flex-grow: 1;
      height: 40px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 16px; /* Set a specific font size to prevent zooming */
    }

    .chat-input input {
      flex: 1;
      height: 40px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0 15px;
      font-size: 16px; /* Set a specific font size to prevent zooming */
    }

    .chat-input button {
      background: black;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      white-space: nowrap;
    }

    .initial-feedback {
      width: 100%;
      margin-bottom: 10px;
    }

    .initial-feedback textarea {
      width: calc(100% - 30px);
      height: 80px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 14px;
      resize: none;
      margin-bottom: 10px;
    }

    .initial-feedback button {
      background-color: #1a73e8; /* Google Maps blue */
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.25px;
      transition: background-color 0.2s;
      width: 100%; /* Make button full width */
      margin-top: 10px;
      text-transform: uppercase; /* Match Google's style */
    }

    .initial-feedback button:hover {
      background-color: #1557b0; /* Darker blue on hover */
    }

    .initial-feedback button:active {
      background-color: #174ea6; /* Even darker when clicked */
    }

    /* Reward section */
    .reward-section {
      background: white;
      border-radius: 10px;
      padding: 20px 15px;
      margin: 20px auto; /* Center the section */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      width: 100%; /* Match parent width */
      box-sizing: border-box;
    }

    .image-placeholder {
      width: 100%;
      height: 150px;
      background-color: #f0f0f0;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 80px;
      position: relative;
      border: 2px dashed #666;
      padding: 10px;
      box-sizing: border-box;
    }

    .free-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #ff4444;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: bold;
      transform: rotate(15deg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .coffee-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .reward-description {
      font-size: 14px;
      line-height: 1.5;
      color: #333;
      margin-bottom: 20px;
      text-align: left;
    }

    .reward-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%; /* Ensure buttons take full width */
    }

    .whatsapp-button, .telegram-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      font-size: 14px;
      transition: opacity 0.2s;
      width: 100%; /* Ensure buttons take full width */
      box-sizing: border-box;
    }

    .whatsapp-button {
      background-color: #25D366;
      color: white;
    }

    .telegram-button {
      background-color: #0088cc;
      color: white;
    }

    .whatsapp-button:hover, .telegram-button:hover {
      opacity: 0.9;
    }

    .whatsapp-button img, .telegram-button img {
      width: 24px;
      height: 24px;
    }

    /* Add CSS for inactive button state */
    .reward-button.inactive {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Chat and Feedback Styles */
    .message.user-message .feedback-header {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding-bottom: 5px;
    }

    .typing-indicator {
      font-size: 14px;
      color: #666;
      font-style: italic;
    }

    .typing-dots {
      display: inline-block;
      width: 30px;
    }

    @keyframes typingDots {
      0% { content: ""; }
      25% { content: "."; }
      50% { content: ".."; }
      75% { content: "..."; }
      100% { content: ""; }
    }

    .typing-dots::after {
      content: "";
      animation: typingDots 1.5s infinite;
    }

    /* Update footer styles */
    footer {
      width: 100%;
      text-align: center;
      padding: 20px 0;
      background-color: #e7b77f;
      position: sticky;
      bottom: 0;
      margin-top: auto; /* Push footer to bottom */
    }

    /* Fix mobile zoom issues */
    @viewport {
      width: device-width;
      zoom: 1.0;
    }

    /* Update textarea and input styles to prevent zoom */
    textarea, input[type="text"] {
      font-size: 16px !important; /* Prevent iOS zoom */
      max-width: 100%;
      box-sizing: border-box;
    }

    /* Prevent horizontal scroll */
    html, body {
      overflow-x: hidden;
      position: relative;
      width: 100%;
    }

    /* Update chat input styles */
    .chat-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .chat-input input {
      flex: 1;
      min-width: 0; /* Prevent input from overflowing */
    }

    /* Feedback Buttons - Google Colors */
    .feedback-buttons .cancel-button {
      width: 33.33%; /* 1/3 width */
      background-color: #E0E0E0; /* Google Grey */
      color: #000000; /* Black Text */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      transition: background-color 0.2s;
    }

    .feedback-buttons .cancel-button:hover {
      background-color: #cfcfcf; /* Darker Grey on Hover */
    }

    .feedback-buttons .submit-button {
      width: 66.67%; /* 2/3 width */
      background-color: #4285F4; /* Google Blue */
      color: #FFFFFF; /* White Text */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      transition: background-color 0.2s;
    }

    .feedback-buttons .submit-button:hover {
      background-color: #357ae8; /* Darker Blue on Hover */
    }

    /* Ensure buttons are displayed in a flex container */
    .feedback-buttons {
      display: flex;
      gap: 10px; /* Optional: space between buttons */
    }

    /* Ensure feedback-buttons styles are after other button styles */
  </style>
</head>
<body>
  <header>
    <div class="logo-title">
      <div class="logo">🍽️</div>
      <h1 data-translate="header.title">La Luna Nel Pozzo</h1>
    </div>
    <div class="flag-selector">
      <select id="language-select">
        <option value="en">🇺🇸</option>
        <option value="it">🇮🇹</option>
      </select>
    </div>
  </header>

  <div class="container">
    <!-- Feedback Section -->
    <div class="feedback-card">
      <h2 data-translate="feedback.title" style="font-size: 24px;">Leave your feedback :)</h2>
      <div class="star-rating">
        <input type="radio" name="rating" value="5" id="star-5"><label for="star-5">★</label>
        <input type="radio" name="rating" value="4" id="star-4"><label for="star-4">★</label>
        <input type="radio" name="rating" value="3" id="star-3"><label for="star-3">★</label>
        <input type="radio" name="rating" value="2" id="star-2"><label for="star-2">★</label>
        <input type="radio" name="rating" value="1" id="star-1"><label for="star-1">★</label>
      </div>
      <div id="feedback-form">
        <div class="initial-feedback">
          <textarea id="initial-message" placeholder="Share details of your own experience at this place..."></textarea>
          <div class="feedback-buttons">
            <button id="cancel-feedback" class="cancel-button" data-translate="feedback.cancel">Cancel</button>
            <button id="submit-initial-feedback" class="submit-button" data-translate="feedback.submit">Post</button>
          </div>
        </div>
        <div class="chat-interface" style="display: none;">
          <div class="chat-messages"></div>
          <div class="chat-input">
            <input type="text" id="chat-message" placeholder="Type your message...">
            <button id="send-chat" data-translate="chat.send">Send</button>
          </div>
        </div>
      </div>
    </div>
    <a href="#" class="reward-button" data-translate="reward.button" id="reward-trigger">🎁 GET FREE REWARD</a>
    <div class="reward-section" style="display: none;">
      <div class="reward-image-placeholder">
        <div class="image-placeholder">
          <div class="coffee-container">
            ☕️
            <div class="free-badge" data-translate="reward.free">FREE</div>
          </div>
        </div>
      </div>
      <p class="reward-description" data-translate="reward.description">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
      <div class="reward-buttons">
        <a href="#" class="whatsapp-button">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTIwLjQ0OSA0LjAxMmMzLjQyMyAzLjQyMyAzLjQyMyA4Ljk3NCAwIDEyLjM5Ny0yLjg3NiAyLjg3Ni03LjI0NCAzLjM3NS0xMC42MTcgMS41MDJsLTQuODMyIDEuNTA1IDEuNTQ0LTQuNTU3Yy0yLjE1MS0zLjQyNC0xLjcwNy04LjAxMyAxLjM0Mi0xMS4wNjIgMy40MjMtMy40MjMgOC45NzQtMy40MjMgMTIuMzk3IDB6bS0yLjE0NiA5LjkzOWMtLjIzOC0uMTE5LTEuNDExLS42OTctMS42MzEtLjc3Ny0uMjItLjA3OS0uMzc5LS4xMTktLjUzOS4xMTktLjE1OS4yMzgtLjYxNy43NzctLjc1Ny45MzctLjE0LjE1OS0uMjc5LjE3OS0uNTE4LjA2LS4yMzktLjExOS0xLjAxMS0uMzcyLTEuOTI1LTEuMTg4LS43MTItLjYzNS0xLjE5My0xLjQxOC0xLjMzMy0xLjY1Ny0uMTQtLjIzOC0uMDE1LS4zNjguMTA1LS40ODcuMTA4LS4xMDcuMjM4LS4yNzkuMzU4LS40MTguMTE5LS4xNC4xNTktLjIzOS4yMzktLjM5OC4wOC0uMTU5LjA0LS4yOTktLjAyLS40MTgtLjA2LS4xMTktLjUzOS0xLjI5Ny0uNzM3LTEuNzc2LS4xOTktLjQ3OC0uMzk4LS40MTgtLjUzOS0uNDE4LS4xNCAwLS4yOTktLjAyLS40NTgtLjAyLS4xNTkgMC0uNDE4LjA2LS42MzcuMjk5LS4yMTkuMjM4LS44MzcuODE3LS44MzcgMS45OTUgMCAxLjE3OC44NTcgMi4zMTYuOTc3IDIuNDc1LjExOS4xNTkgMS42OSAyLjU4MSA0LjA5MyAzLjYxOSAxLjUzMS41OTYgMi4wNjguNDc4IDIuNzY2LjQxOC42MTctLjEgMS44OTUtLjc3NyAyLjE2My0xLjUzLjI2OC0uNzU2LjI2OC0xLjQwNC4xODgtMS41MjQtLjA4LS4xMTktLjI3OS0uMTc5LS41MTgtLjI5OHoiLz48L3N2Zz4=" alt="WhatsApp">
          <span data-translate="reward.whatsapp">GET IT ON WHATSAPP</span>
        </a>
        <a href="https://t.me/TapDoorSample_bot" target="_blank" class="telegram-button">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTkuNzggMTguNjVMMTAuMDYgMTQuNzJMMTcuNzYgNy41QzE4LjEzIDcuMTQgMTcuNzYgNyAxNy4zNyA3LjMxTDcuNTggMTMuNDhMMy44NSAxMi4wOUM0LjY4IDExLjkgOC4yOCAxMC41IDguMjggMTAuNUwxOC4zNiA2LjY0QzE5LjE1IDYuMzEgMTkuOTcgNi45NyAxOS42MiA4LjQ3TDE3LjA1IDE4LjE4QzE2Ljg0IDE5LjIxIDE1Ljk0IDE5LjU5IDE1LjEgMTkuMDZMMTEuMSAxNi4xTDkuMTIgMTguMDJDOC45IDE4LjI0IDguNzIgMTguNDEgOC4yOCAxOC40MUM3Ljg0IDE4LjQxIDcuOTQgMTguMjQgNy43OCAxNy44MUw2LjI2IDEzLjg3TDIuNzUgMTIuNzFDMS44NSAxMi4zNSAxLjg1IDExLjQxIDIuOTUgMTEuMDNMMTkuMzUgNS4wNUMyMC4yIDQuNzEgMjAuOTUgNS40MiAyMC42IDYuOTJMMTcuNiAxOS4zN0MxNy4zOCAyMC42IDE2LjM0IDIwLjk3IDE1LjM3IDIwLjM3TDExLjc1IDE3LjU5TDkuNzUgMTkuNDJDOS41MyAxOS42NCA5LjM1IDE5LjgxIDguOTEgMTkuODFDOC40NyAxOS44MSA4LjU3IDE5LjY0IDguNDEgMTkuMjFMNi44OSAxNS4yN0wzLjM4IDE0LjFDMi40OCAxMy43NCAyLjQ4IDEyLjggMy41OCAxMi40MkwyMCAwLjQyQzIwLjg1IDAuMDggMjEuNiAwLjc5IDIxLjI1IDIuMjlMMTcuNiAxOS4zN0MxNy4zOCAyMC42IDE2LjM0IDIwLjk3IDE1LjM3IDIwLjM3TDExLjc1IDE3LjU5TDkuNzggMTguNjVaIi8+PC9zdmc+" alt="Telegram">
          <span data-translate="reward.telegram">GET IT ON TELEGRAM</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Chatbot Section (Commented out) -->
  <!--
  <div class="section">
    <h2 data-translate="section.chat.title">Chat with Us</h2>
    <div id="chat-container">
      <div id="chat-window"></div>
      <div id="loading">...</div>
      <div id="chat-input">
        <input type="text" id="message-input" placeholder="Type your message here..." />
        <button id="send-button" data-translate="chat.send">Send</button>
      </div>
    </div>
  </div>
  -->

  <!-- Quiz Section (Commented out) -->
  <!--
  <div class="section">
    <h2 data-translate="section.quiz.title">Take a Quick Quiz</h2>
    <p data-translate="section.quiz.description">Complete this quiz to win a free coffee!</p>
    <iframe src="https://docs.google.com/forms/d/e/your-form-id/viewform"></iframe>
  </div>
  -->

  <footer>
    <p data-translate="footer.text">&copy; 2024 TapDoor</p>
  </footer>

  <script>
    // Translations
    const translations = {
      en: {
        "title": "Restaurant La Luna Nel Pozzo",
        "header.title": "La Luna",
        "feedback.title": "Leave your feedback :)",
        "feedback.placeholder": "Share details of your own experience at this place...",
        "feedback.submit": "Post",
        "feedback.received": "We have received your feedback:",
        "reward.button": "🎁 GET FREE REWARD",
        "reward.description": "Get a <b>free coffee</b> by showing the coupon to the waiter. Click below and claim this directly on Whatsapp or Telegram.",
        "reward.whatsapp": "GET IT ON WHATSAPP",
        "reward.telegram": "GET IT ON TELEGRAM",
        "chat.typing": "is typing",
        "reward.free": "FREE",
        "chat.send": "Send",
        "feedback.cancel": "Cancel",
        "feedback.empty": "Thank you for your feedback!"
      },
      it: {
        "title": "La Luna",
        "header.title": "La Luna Nel Pozzo",
        "feedback.title": "Lascia il tuo feedback :)",
        "feedback.placeholder": "Condividi i dettagli della tua esperienza in questo luogo...",
        "feedback.submit": "Pubblica",
        "feedback.received": "Abbiamo ricevuto il tuo feedback:",
        "reward.button": "🎁 RICEVI UN PREMIO",
        "reward.description": "Ottieni un <b>caffè gratis</b> mostrando il coupon al cameriere. Clicca qui sotto e richiedilo direttamente su Whatsapp o Telegram.",
        "reward.whatsapp": "RICEVI SU WHATSAPP",
        "reward.telegram": "RICEVI SU TELEGRAM",
        "chat.typing": "sta scrivendo",
        "reward.free": "GRATIS",
        "chat.send": "Invia",
        "feedback.cancel": "Annulla",
        "feedback.empty": "Grazie per il tuo feedback!"
      }
    };

    // Language persistence with cookie and localStorage fallback
    function setLanguagePreference(lang) {
      try {
        // Try to set cookie first (for hosted environments)
        const expires = new Date();
        expires.setTime(expires.getTime() + (365 * 24 * 60 * 60 * 1000));
        document.cookie = `preferredLanguage=${lang};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        
        // Also set in localStorage as fallback
        localStorage.setItem('preferredLanguage', lang);
        console.log('Saved language preference:', lang);
      } catch (e) {
        console.error('Error saving language:', e);
      }
    }

    function getLanguagePreference() {
      try {
        // Try to get from cookie first
        const cookieMatch = document.cookie.match(/preferredLanguage=([^;]+)/);
        if (cookieMatch) {
          console.log('Retrieved language from cookie:', cookieMatch[1]);
          return cookieMatch[1];
        }
        
        // Fallback to localStorage
        const localStorageLang = localStorage.getItem('preferredLanguage');
        if (localStorageLang) {
          console.log('Retrieved language from localStorage:', localStorageLang);
          return localStorageLang;
        }
        
        return null;
      } catch (e) {
        console.error('Error getting language:', e);
        return null;
      }
    }

    // Update language handling
    function setLanguage(lang) {
      console.log('Setting language to:', lang);
      document.querySelectorAll("[data-translate]").forEach(el => {
        const key = el.getAttribute("data-translate");
        if (translations[lang][key]) {
          el.innerHTML = translations[lang][key];
        }
      });
      document.getElementById('language-select').value = lang;
      setLanguagePreference(lang);

      // Update the placeholder for the feedback textarea
      const feedbackTextarea = document.getElementById('initial-message');
      feedbackTextarea.placeholder = translations[lang]['feedback.placeholder'];
    }

    // Update initialization
    window.addEventListener('load', () => {
      console.log('Page loaded, checking for saved language');
      const savedLanguage = getLanguagePreference();
      console.log('Saved language found:', savedLanguage);
      if (savedLanguage) {
        setLanguage(savedLanguage);
      } else {
        console.log('No saved language found, defaulting to en');
        setLanguage('en');
      }
    });

    // Keep the language change handler
    document.getElementById("language-select").addEventListener("change", (e) => {
      setLanguage(e.target.value);
    });

    // Update star rating handler
    document.querySelectorAll('.star-rating input').forEach(star => {
      star.addEventListener('change', function () {
        const rating = parseInt(this.value, 10);
        const feedbackForm = document.getElementById('feedback-form');
        const rewardButton = document.getElementById('reward-trigger');
        const rewardSection = document.querySelector('.reward-section');
        
        if (rating >= 4) {
          window.open('https://search.google.com/local/writereview?placeid=ChIJ9bSHICZbRhMRYlkGiRpucPo', '_blank');
        } else {
          // Show feedback form and disable reward button
          feedbackForm.style.display = 'block';
          rewardButton.classList.add('inactive');
          // Hide reward section if open
          rewardSection.style.display = 'none';
        }
      });
    });

    // Add cancel button handler
    document.getElementById('cancel-feedback').addEventListener('click', function() {
      const feedbackForm = document.getElementById('feedback-form');
      feedbackForm.style.display = 'none';
      document.getElementById('reward-trigger').classList.remove('inactive');
    });

    // Add this near the top of your script section
    const chatApiUrl = 'https://dev-docker.therightdot.com/cc/chat';
    let currentThreadId = null;

    async function sendMessage(message) {
      const headers = { 
        'Content-Type': 'application/json', 
        'Authorization': 'Bearer hr-mr-d01' 
      };
      
      try {
        const response = await fetch(chatApiUrl, { 
          method: 'POST', 
          headers, 
          body: JSON.stringify({ 
            message, 
            threadId: currentThreadId 
          }) 
        });
        
        const data = await response.json();
        currentThreadId = data.threadId;
        return data.message;
      } catch (error) {
        console.error('Error:', error);
        return 'Sorry, there was an error processing your message.';
      }
    }

    // Update feedback submission handler
    document.getElementById('submit-initial-feedback').addEventListener('click', async function() {
      const initialMessage = document.getElementById('initial-message');
      const message = initialMessage.value.trim();
      const rewardButton = document.getElementById('reward-trigger');
      
      if (message) {
        // Re-enable reward button
        rewardButton.classList.remove('inactive');
        
        // Hide initial feedback interface
        document.querySelector('.initial-feedback').style.display = 'none';
        
        // Show chat interface
        const chatInterface = document.querySelector('.chat-interface');
        chatInterface.style.display = 'block';
        
        const chatMessages = document.querySelector('.chat-messages');
        
        // Create combined feedback message with header
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        
        // Add feedback header
        const feedbackHeader = document.createElement('div');
        feedbackHeader.className = 'feedback-header';
        const currentLang = document.getElementById('language-select').value;
        feedbackHeader.textContent = translations[currentLang]['feedback.received'];
        
        // Add message content
        const messageContent = document.createElement('div');
        messageContent.textContent = message;
        
        // Combine header and message
        userMessageDiv.appendChild(feedbackHeader);
        userMessageDiv.appendChild(messageContent);
        chatMessages.appendChild(userMessageDiv);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Send the initial message to the web service
        try {
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'message server-message typing-indicator';
          const businessName = translations[currentLang]['header.title'];
          loadingDiv.innerHTML = `${businessName} ${translations[currentLang]['chat.typing']}<span class="typing-dots"></span>`;
          chatMessages.appendChild(loadingDiv);
          
          const serverResponse = await sendMessage(message);
          
          // Remove typing indicator and add server response
          chatMessages.removeChild(loadingDiv);
          
          // Add server response after a small delay
          setTimeout(() => {
            const serverMessageDiv = document.createElement('div');
            serverMessageDiv.className = 'message server-message';
            serverMessageDiv.textContent = serverResponse;
            chatMessages.appendChild(serverMessageDiv);
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 100);
          
        } catch (error) {
          console.error('Error:', error);
          chatMessages.removeChild(loadingDiv); // Make sure to remove loading on error
        }
      }
    });

    // Handle ongoing chat messages
    document.getElementById('send-chat').addEventListener('click', async function() {
      const messageInput = document.getElementById('chat-message');
      const message = messageInput.value.trim();
      
      if (message) {
        const chatMessages = document.querySelector('.chat-messages');
        
        // Add user message
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        userMessageDiv.textContent = message;
        chatMessages.appendChild(userMessageDiv);
        
        // Clear input
        messageInput.value = '';
        
        try {
          // Show typing indicator
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'message server-message typing-indicator';
          const currentLang = document.getElementById('language-select').value;
          const businessName = translations[currentLang]['header.title'];
          loadingDiv.innerHTML = `${businessName} ${translations[currentLang]['chat.typing']}<span class="typing-dots"></span>`;
          chatMessages.appendChild(loadingDiv);
          
          // Send to server and get response
          const serverResponse = await sendMessage(message);
          
          // Remove typing indicator and add server response
          chatMessages.removeChild(loadingDiv);
          
          // Add server response after a small delay
          setTimeout(() => {
            const serverMessageDiv = document.createElement('div');
            serverMessageDiv.className = 'message server-message';
            serverMessageDiv.textContent = serverResponse;
            chatMessages.appendChild(serverMessageDiv);
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }, 100);
          
        } catch (error) {
          console.error('Error:', error);
          chatMessages.removeChild(loadingDiv); // Make sure to remove loading on error
        }
      }
    });

    // Allow sending chat messages with Enter key
    document.getElementById('chat-message').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('send-chat').click();
      }
    });

    // Update reward button handler with smooth scroll
    document.getElementById('reward-trigger').addEventListener('click', function(e) {
      e.preventDefault();
      const rewardSection = document.querySelector('.reward-section');
      const feedbackForm = document.getElementById('feedback-form');
      
      if (rewardSection.style.display === 'none') {
        rewardSection.style.display = 'block';
        feedbackForm.style.display = 'none';
        
        // Smooth scroll to reward section
        setTimeout(() => {
          rewardSection.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
          });
        }, 100); // Small delay to ensure the section is visible first
      } else {
        rewardSection.style.display = 'none';
      }
    });
  </script>
</body>
</html>
